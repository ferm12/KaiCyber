import { useEffect, useMemo, useState, useCallback } from 'react';
import {
  Box,
  Paper,
  Typography,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  TablePagination,
  TableSortLabel,
  Chip,
  IconButton,
  TextField,
  InputAdornment,
  MenuItem,
  Select,
  FormControl,
  InputLabel,
  Button,
  Tooltip,
} from '@mui/material';
import { useNavigate } from 'react-router-dom';
import SearchIcon from '@mui/icons-material/Search';
import VisibilityIcon from '@mui/icons-material/Visibility';
import DownloadIcon from '@mui/icons-material/Download';
import { useAppDispatch, useAppSelector } from '../store/hooks';
import {
  setSearchQuery,
  setSeverity,
  setCvssRange,
  setPackageName,
  setCve,
} from '../store/slices/filtersSlice';
import {
  setFilteredVulnerabilities,
  updateMetrics,
} from '../store/slices/vulnerabilitiesSlice';
import { setSortBy, setItemsPerPage } from '../store/slices/uiSlice';
import { applyFilters, sortVulnerabilities } from '../utils/filterUtils';
import { exportToCSV } from '../utils/exportUtils';
import { Severity } from '../types/vulnerability';

type SortField = 'cve' | 'severity' | 'cvss' | 'packageName' | 'published';

function VulnerabilityList() {
  const navigate = useNavigate();
  const dispatch = useAppDispatch();
  const { processedVulnerabilities, filteredVulnerabilities } = useAppSelector(
    (state) => state.vulnerabilities
  );
  const filters = useAppSelector((state) => state.filters);
  const { sortBy, itemsPerPage } = useAppSelector((state) => state.ui);

  const [page, setPage] = useState(0);

  // Apply filters
  useEffect(() => {
    const filtered = applyFilters(processedVulnerabilities, filters);
    const sorted = sortVulnerabilities(filtered, sortBy.field, sortBy.direction);
    dispatch(setFilteredVulnerabilities(sorted));
    dispatch(updateMetrics(sorted));
  }, [processedVulnerabilities, filters, sortBy, dispatch]);

  // Handle search input with debouncing
  const handleSearchChange = useCallback((value: string) => {
    dispatch(setSearchQuery(value));
  }, [dispatch]);

  // Get unique values for filters
  const uniqueSeverities = useMemo(() => {
    const severities = new Set<Severity>();
    processedVulnerabilities.forEach((v) => severities.add(v.severity));
    return Array.from(severities);
  }, [processedVulnerabilities]);

  // Paginated data
  const paginatedData = useMemo(() => {
    const start = page * itemsPerPage;
    return filteredVulnerabilities.slice(start, start + itemsPerPage);
  }, [filteredVulnerabilities, page, itemsPerPage]);

  const handleSort = (field: SortField) => {
    const direction =
      sortBy.field === field && sortBy.direction === 'asc' ? 'desc' : 'asc';
    dispatch(setSortBy({ field, direction }));
  };

  const handleExport = () => {
    exportToCSV(filteredVulnerabilities, 'vulnerabilities');
  };

  const getSeverityColor = (severity: Severity) => {
    switch (severity) {
      case 'critical':
        return 'error';
      case 'high':
        return 'warning';
      case 'medium':
        return 'info';
      case 'low':
        return 'success';
      default:
        return 'default';
    }
  };

  return (
    <Box>
      <Box
        sx={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          mb: 3,
        }}
      >
        <Typography variant="h4" component="h1" fontWeight="bold">
          Vulnerabilities
        </Typography>
        <Button
          variant="outlined"
          startIcon={<DownloadIcon />}
          onClick={handleExport}
        >
          Export CSV
        </Button>
      </Box>

      {/* Filters */}
      <Paper sx={{ p: 2, mb: 3 }}>
        <Box sx={{ display: 'flex', gap: 2, flexWrap: 'wrap' }}>
          <TextField
            label="Search"
            variant="outlined"
            size="small"
            value={filters.searchQuery}
            onChange={(e) => handleSearchChange(e.target.value)}
            InputProps={{
              startAdornment: (
                <InputAdornment position="start">
                  <SearchIcon />
                </InputAdornment>
              ),
            }}
            sx={{ minWidth: 250 }}
          />
          <TextField
            label="CVE"
            variant="outlined"
            size="small"
            value={filters.cve}
            onChange={(e) => dispatch(setCve(e.target.value))}
            sx={{ minWidth: 200 }}
          />
          <TextField
            label="Package Name"
            variant="outlined"
            size="small"
            value={filters.packageName}
            onChange={(e) => dispatch(setPackageName(e.target.value))}
            sx={{ minWidth: 200 }}
          />
          <FormControl size="small" sx={{ minWidth: 150 }}>
            <InputLabel>Severity</InputLabel>
            <Select
              multiple
              value={filters.severity}
              onChange={(e) =>
                dispatch(setSeverity(e.target.value as Severity[]))
              }
              label="Severity"
            >
              {uniqueSeverities.map((sev) => (
                <MenuItem key={sev} value={sev}>
                  {sev}
                </MenuItem>
              ))}
            </Select>
          </FormControl>
          <TextField
            label="Min CVSS"
            type="number"
            variant="outlined"
            size="small"
            value={filters.minCvss}
            onChange={(e) =>
              dispatch(
                setCvssRange({
                  min: parseFloat(e.target.value) || 0,
                  max: filters.maxCvss,
                })
              )
            }
            inputProps={{ min: 0, max: 10, step: 0.1 }}
            sx={{ width: 120 }}
          />
          <TextField
            label="Max CVSS"
            type="number"
            variant="outlined"
            size="small"
            value={filters.maxCvss}
            onChange={(e) =>
              dispatch(
                setCvssRange({
                  min: filters.minCvss,
                  max: parseFloat(e.target.value) || 10,
                })
              )
            }
            inputProps={{ min: 0, max: 10, step: 0.1 }}
            sx={{ width: 120 }}
          />
        </Box>
      </Paper>

      {/* Results count */}
      <Typography variant="body2" color="textSecondary" sx={{ mb: 2 }}>
        Showing {filteredVulnerabilities.length.toLocaleString()} of{' '}
        {processedVulnerabilities.length.toLocaleString()} vulnerabilities
      </Typography>

      {/* Table */}
      <TableContainer component={Paper}>
        <Table>
          <TableHead>
            <TableRow>
              <TableCell>
                <TableSortLabel
                  active={sortBy.field === 'cve'}
                  direction={sortBy.field === 'cve' ? sortBy.direction : 'asc'}
                  onClick={() => handleSort('cve')}
                >
                  CVE
                </TableSortLabel>
              </TableCell>
              <TableCell>
                <TableSortLabel
                  active={sortBy.field === 'severity'}
                  direction={
                    sortBy.field === 'severity' ? sortBy.direction : 'asc'
                  }
                  onClick={() => handleSort('severity')}
                >
                  Severity
                </TableSortLabel>
              </TableCell>
              <TableCell>
                <TableSortLabel
                  active={sortBy.field === 'cvss'}
                  direction={sortBy.field === 'cvss' ? sortBy.direction : 'asc'}
                  onClick={() => handleSort('cvss')}
                >
                  CVSS
                </TableSortLabel>
              </TableCell>
              <TableCell>
                <TableSortLabel
                  active={sortBy.field === 'packageName'}
                  direction={
                    sortBy.field === 'packageName' ? sortBy.direction : 'asc'
                  }
                  onClick={() => handleSort('packageName')}
                >
                  Package
                </TableSortLabel>
              </TableCell>
              <TableCell>Version</TableCell>
              <TableCell>Status</TableCell>
              <TableCell>Kai Status</TableCell>
              <TableCell align="right">Actions</TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {paginatedData.map((vuln) => (
              <TableRow key={vuln.id} hover>
                <TableCell>
                  <Typography
                    variant="body2"
                    sx={{ fontFamily: 'monospace', fontWeight: 'bold' }}
                  >
                    {vuln.cve}
                  </Typography>
                </TableCell>
                <TableCell>
                  <Chip
                    label={vuln.severity}
                    color={getSeverityColor(vuln.severity)}
                    size="small"
                  />
                </TableCell>
                <TableCell>
                  <Typography variant="body2" fontWeight="bold">
                    {vuln.cvss.toFixed(1)}
                  </Typography>
                </TableCell>
                <TableCell>{vuln.packageName}</TableCell>
                <TableCell>
                  <Typography variant="body2" color="textSecondary">
                    {vuln.packageVersion}
                  </Typography>
                </TableCell>
                <TableCell>
                  <Typography variant="body2" noWrap sx={{ maxWidth: 200 }}>
                    {vuln.status}
                  </Typography>
                </TableCell>
                <TableCell>
                  {vuln.kaiStatus && (
                    <Chip
                      label={vuln.kaiStatus}
                      size="small"
                      variant="outlined"
                    />
                  )}
                </TableCell>
                <TableCell align="right">
                  <Tooltip title="View Details">
                    <IconButton
                      size="small"
                      onClick={() => navigate(`/vulnerabilities/${vuln.id}`)}
                    >
                      <VisibilityIcon />
                    </IconButton>
                  </Tooltip>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
        <TablePagination
          component="div"
          count={filteredVulnerabilities.length}
          page={page}
          onPageChange={(_, newPage) => setPage(newPage)}
          rowsPerPage={itemsPerPage}
          onRowsPerPageChange={(e) => {
            dispatch(setItemsPerPage(parseInt(e.target.value, 10)));
            setPage(0);
          }}
          rowsPerPageOptions={[25, 50, 100, 200]}
        />
      </TableContainer>
    </Box>
  );
}

export default VulnerabilityList;

