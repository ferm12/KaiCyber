import { useParams, useNavigate } from 'react-router-dom';
import {
  Box,
  Paper,
  Typography,
  Button,
  Chip,
  Grid,
  Divider,
  Link,
  Card,
  CardContent,
  List,
  ListItem,
  ListItemText,
} from '@mui/material';
import ArrowBackIcon from '@mui/icons-material/ArrowBack';
import OpenInNewIcon from '@mui/icons-material/OpenInNew';
import { useAppSelector } from '../store/hooks';
import { parseDateString } from '../utils/dataProcessor';

function VulnerabilityDetail() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const { filteredVulnerabilities } = useAppSelector(
    (state) => state.vulnerabilities
  );

  const vulnerability = filteredVulnerabilities.find((v) => v.id === id);

  if (!vulnerability) {
    return (
      <Box>
        <Typography variant="h5">Vulnerability not found</Typography>
        <Button onClick={() => navigate('/vulnerabilities')} sx={{ mt: 2 }}>
          Back to List
        </Button>
      </Box>
    );
  }

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'critical':
        return 'error';
      case 'high':
        return 'warning';
      case 'medium':
        return 'info';
      case 'low':
        return 'success';
      default:
        return 'default';
    }
  };

  const riskFactors = Object.keys(vulnerability.riskFactors);

  return (
    <Box>
      <Button
        startIcon={<ArrowBackIcon />}
        onClick={() => navigate('/vulnerabilities')}
        sx={{ mb: 3 }}
      >
        Back to List
      </Button>

      <Paper sx={{ p: 4 }}>
        <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 3 }}>
          <Box>
            <Typography variant="h4" component="h1" gutterBottom>
              {vulnerability.cve}
            </Typography>
            <Box sx={{ display: 'flex', gap: 1, mt: 1 }}>
              <Chip
                label={vulnerability.severity}
                color={getSeverityColor(vulnerability.severity)}
                size="medium"
              />
              {vulnerability.kaiStatus && (
                <Chip
                  label={`Kai: ${vulnerability.kaiStatus}`}
                  variant="outlined"
                  size="medium"
                />
              )}
            </Box>
          </Box>
          <Box>
            <Typography variant="h3" color="primary" fontWeight="bold">
              CVSS: {vulnerability.cvss.toFixed(1)}
            </Typography>
          </Box>
        </Box>

        <Divider sx={{ my: 3 }} />

        <Grid container spacing={3}>
          <Grid item xs={12} md={6}>
            <Card variant="outlined">
              <CardContent>
                <Typography variant="h6" gutterBottom>
                  Package Information
                </Typography>
                <List dense>
                  <ListItem>
                    <ListItemText
                      primary="Package Name"
                      secondary={vulnerability.packageName}
                    />
                  </ListItem>
                  <ListItem>
                    <ListItemText
                      primary="Package Version"
                      secondary={vulnerability.packageVersion}
                    />
                  </ListItem>
                  <ListItem>
                    <ListItemText
                      primary="Package Type"
                      secondary={vulnerability.packageType}
                    />
                  </ListItem>
                </List>
              </CardContent>
            </Card>
          </Grid>

          <Grid item xs={12} md={6}>
            <Card variant="outlined">
              <CardContent>
                <Typography variant="h6" gutterBottom>
                  Status & Dates
                </Typography>
                <List dense>
                  <ListItem>
                    <ListItemText
                      primary="Status"
                      secondary={vulnerability.status}
                    />
                  </ListItem>
                  <ListItem>
                    <ListItemText
                      primary="Published"
                      secondary={
                        (() => {
                          const date = parseDateString(vulnerability.publishedDate);
                          return date
                            ? date.toLocaleDateString()
                            : vulnerability.published;
                        })()
                      }
                    />
                  </ListItem>
                  <ListItem>
                    <ListItemText
                      primary="Fix Date"
                      secondary={
                        (() => {
                          const date = parseDateString(vulnerability.fixDateParsed);
                          return date
                            ? date.toLocaleDateString()
                            : vulnerability.fixDate;
                        })()
                      }
                    />
                  </ListItem>
                </List>
              </CardContent>
            </Card>
          </Grid>

          <Grid item xs={12}>
            <Card variant="outlined">
              <CardContent>
                <Typography variant="h6" gutterBottom>
                  Description
                </Typography>
                <Typography variant="body1" paragraph>
                  {vulnerability.description || 'No description available.'}
                </Typography>
              </CardContent>
            </Card>
          </Grid>

          {riskFactors.length > 0 && (
            <Grid item xs={12}>
              <Card variant="outlined">
                <CardContent>
                  <Typography variant="h6" gutterBottom>
                    Risk Factors
                  </Typography>
                  <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1 }}>
                    {riskFactors.map((factor) => (
                      <Chip key={factor} label={factor} size="small" />
                    ))}
                  </Box>
                </CardContent>
              </Card>
            </Grid>
          )}

          <Grid item xs={12} md={6}>
            <Card variant="outlined">
              <CardContent>
                <Typography variant="h6" gutterBottom>
                  Deployment Information
                </Typography>
                <List dense>
                  <ListItem>
                    <ListItemText
                      primary="Group"
                      secondary={vulnerability.groupName}
                    />
                  </ListItem>
                  <ListItem>
                    <ListItemText
                      primary="Repository"
                      secondary={vulnerability.repoName}
                    />
                  </ListItem>
                  <ListItem>
                    <ListItemText
                      primary="Image"
                      secondary={vulnerability.imageName}
                    />
                  </ListItem>
                  <ListItem>
                    <ListItemText
                      primary="Image Version"
                      secondary={vulnerability.imageVersion}
                    />
                  </ListItem>
                </List>
              </CardContent>
            </Card>
          </Grid>

          {vulnerability.applicableRules.length > 0 && (
            <Grid item xs={12} md={6}>
              <Card variant="outlined">
                <CardContent>
                  <Typography variant="h6" gutterBottom>
                    Applicable Rules
                  </Typography>
                  <List dense>
                    {vulnerability.applicableRules.map((rule, index) => (
                      <ListItem key={index}>
                        <ListItemText primary={rule} />
                      </ListItem>
                    ))}
                  </List>
                </CardContent>
              </Card>
            </Grid>
          )}

          {vulnerability.link && (
            <Grid item xs={12}>
              <Card variant="outlined">
                <CardContent>
                  <Typography variant="h6" gutterBottom>
                    External Links
                  </Typography>
                  <Link
                    href={vulnerability.link}
                    target="_blank"
                    rel="noopener noreferrer"
                    sx={{ display: 'flex', alignItems: 'center', gap: 1 }}
                  >
                    View on NVD
                    <OpenInNewIcon fontSize="small" />
                  </Link>
                </CardContent>
              </Card>
            </Grid>
          )}
        </Grid>
      </Paper>
    </Box>
  );
}

export default VulnerabilityDetail;

